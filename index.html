<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOGÍSTICA - Control de Personal</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="manifest" id="my-manifest">
    <script>
        const manifest = {
            "name": "Logística App",
            "short_name": "Logística",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#2563eb",
            "orientation": "portrait",
            "icons": [
                { "src": "https://cdn-icons-png.flaticon.com/512/716/716736.png", "sizes": "192x192", "type": "image/png" },
                { "src": "https://cdn-icons-png.flaticon.com/512/716/716736.png", "sizes": "512x512", "type": "image/png" }
            ]
        };
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('#my-manifest').setAttribute('href', manifestURL);
    </script>

    <style>
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-950 overscroll-none transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Truck, Users, Moon, Sun, FileSpreadsheet, CheckCircle2, 
          AlertCircle, UserMinus, UserX, UserPlus, Settings, X, Search, 
          Plus, ToggleLeft, ToggleRight, Trash2, RotateCcw, 
          Check, Loader2, FileText, Lock
        } from 'lucide-react';

        // --- CONFIGURACIÓN DE FLOTA ---
        const BORNEO_TRUCKS = new Set(["C35", "C38", "C39", "C40", "C41", "C42", "C43", "C44"]);
        const FLETERO_TRUCKS = new Set(["F1", "F2"]);
        
        const INITIAL_TRUCKS = [
            "C14", "C15", "C16", "C17", "C18", "C19", "C20", 
            "C26", "C27", "C28", "C29", "C30", "C31", "C32", 
            "C33", "C34", "C36", "C37", "F2", "F1", 
            "C35", "C38", "C39", "C40", "C41", "C42", "C44", "C43"
        ];

        const INITIAL_STAFF_DATA = [
            { id: 1, name: "Juan Cabrera", role: "Entregador", isDriver: false },
            { id: 2, name: "Hector Valiente", role: "Ayudante", isDriver: true },
            { id: 3, name: "Bryan Britez", role: "Volante", isDriver: false },
            { id: 4, name: "Roberto Lopez", role: "Entregador", isDriver: false },
            { id: 5, name: "Juan Villamayor", role: "Ayudante", isDriver: true },
            { id: 6, name: "Marcelo Melgarejo", role: "Entregador", isDriver: true },
            { id: 7, name: "Lucas Martinez", role: "Ayudante", isDriver: false },
            { id: 8, name: "Hugo Olmedo", role: "Entregador", isDriver: true },
            { id: 9, name: "Diego Cordoba", role: "Ayudante", isDriver: false },
            { id: 10, name: "Ismael Gimenez", role: "Volante", isDriver: true },
            { id: 11, name: "Isaias Jara", role: "Entregador", isDriver: true },
            { id: 12, name: "Edgar Avalos", role: "Ayudante", isDriver: false },
            { id: 13, name: "Jose Caballero", role: "Entregador", isDriver: true },
            { id: 14, name: "Alexander Martinez", role: "Ayudante", isDriver: false },
            { id: 15, name: "Rody Gonzalez", role: "Entregador", isDriver: true },
            { id: 16, name: "Lizandro Cuba", role: "Ayudante", isDriver: false },
            { id: 17, name: "Juan Samudio", role: "Entregador", isDriver: true },
            { id: 18, name: "Dario Rolon", role: "Ayudante", isDriver: false },
            { id: 19, name: "Jose Orrego", role: "Volante", isDriver: true },
            { id: 20, name: "Ayrton Delgado", role: "Entregador", isDriver: true },
            { id: 21, name: "Joaquin Ayala", role: "Ayudante", isDriver: false },
            { id: 22, name: "Mathias Huesped", role: "Entregador", isDriver: true },
            { id: 23, name: "Victor Espinoza", role: "Ayudante", isDriver: false },
            { id: 24, name: "Junior Caceres", role: "Volante", isDriver: false },
            { id: 25, name: "Nicolas Vega", role: "Entregador", isDriver: false },
            { id: 26, name: "Alberto Caceres", role: "Ayudante", isDriver: true },
            { id: 27, name: "Cesar Duarte", role: "Volante", isDriver: true },
            { id: 28, name: "Antonio Mereles", role: "Entregador", isDriver: false },
            { id: 29, name: "Gabriel Flores", role: "Ayudante", isDriver: true },
            { id: 30, name: "Nestor Ruis Diaz", role: "Entregador", isDriver: true },
            { id: 31, name: "Juan Velasquez", role: "Ayudante", isDriver: false },
            { id: 32, name: "Arsenio Mendieta", role: "Entregador", isDriver: true },
            { id: 33, name: "Jorge Jara", role: "Ayudante", isDriver: false },
            { id: 34, name: "Lucas Infran", role: "Volante", isDriver: false },
            { id: 35, name: "Juan Pereira", role: "Entregador", isDriver: true },
            { id: 36, name: "Alberto Franco", role: "Ayudante", isDriver: false },
            { id: 37, name: "Carlos Ruiz", role: "Entregador", isDriver: true },
            { id: 38, name: "Fletero 1", role: "Ayudante", isDriver: false, isFletero: true },
            { id: 39, name: "Nicolas Vera", role: "Entregador", isDriver: false },
            { id: 40, name: "Fletero 2", role: "Ayudante", isDriver: false, isFletero: true },
            { id: 41, name: "Nicolas Rojas", role: "Entregador", isDriver: true },
            { id: 42, name: "Marcos Sanchez", role: "Entregador", isDriver: true },
            { id: 43, name: "Cristhian Benitez", role: "Entregador", isDriver: true },
            { id: 44, name: "Orlando Penayo", role: "Entregador", isDriver: true },
            { id: 45, name: "Pablo Quiñonez", role: "Entregador", isDriver: true },
            { id: 46, name: "Walter Caballero", role: "Entregador", isDriver: true },
            { id: 47, name: "Juan Rolon", role: "Entregador", isDriver: true },
            { id: 48, name: "Gustavo Caceres", role: "Entregador", isDriver: true },
        ];

        const createEmptyAssignments = () => {
            const empty = {};
            INITIAL_TRUCKS.forEach(truckId => {
                empty[truckId] = { driver: null, helper1: null, helper2: null, observation: "" };
            });
            return empty;
        };

        const INITIAL_ASSIGNMENTS = {
            "C15": { driver: 1, helper1: 2, helper2: 3, observation: "" },
            "C16": { driver: 4, helper1: 5, helper2: null, observation: "" },
            "C17": { driver: 6, helper1: 7, helper2: null, observation: "" },
            "C20": { driver: 8, helper1: 9, helper2: 10, observation: "" },
            "C26": { driver: 11, helper1: 12, helper2: null, observation: "" },
            "C27": { driver: 13, helper1: 14, helper2: null, observation: "" },
            "C28": { driver: 15, helper1: 16, helper2: null, observation: "" },
            "C29": { driver: 17, helper1: 18, helper2: 19, observation: "" },
            "C30": { driver: 20, helper1: 21, helper2: null, observation: "" },
            "C31": { driver: 22, helper1: 23, helper2: 24, observation: "" },
            "C32": { driver: 25, helper1: 26, helper2: 27, observation: "" },
            "C33": { driver: 28, helper1: 29, helper2: null, observation: "" },
            "C34": { driver: 30, helper1: 31, helper2: null, observation: "" },
            "C36": { driver: 32, helper1: 33, helper2: 34, observation: "" },
            "C37": { driver: 35, helper1: 36, helper2: null, observation: "" },
            "F2": { driver: 37, helper1: 38, helper2: null, observation: "" },
            "F1": { driver: 39, helper1: 40, helper2: null, observation: "" },
            "C35": { driver: 41, helper1: null, helper2: null, observation: "" },
            "C38": { driver: 42, helper1: null, helper2: null, observation: "" },
            "C39": { driver: 43, helper1: null, helper2: null, observation: "" },
            "C40": { driver: 44, helper1: null, helper2: null, observation: "" },
            "C41": { driver: 45, helper1: null, helper2: null, observation: "" },
            "C42": { driver: 46, helper1: null, helper2: null, observation: "" },
            "C44": { driver: 47, helper1: null, helper2: null, observation: "" },
            "C43": { driver: 48, helper1: null, helper2: null, observation: "" },
        };

        const StaffSelectorModal = ({ isOpen, onClose, availableStaff, onAssign, onMarkAbsent, darkMode, truckId, isTruckDeparted }) => {
            const [isMarkingAbsent, setIsMarkingAbsent] = useState(false);
            const [absentReason, setAbsentReason] = useState("");

            useEffect(() => {
                if(isOpen) {
                    setIsMarkingAbsent(false);
                    setAbsentReason("");
                }
            }, [isOpen]);

            const handleEmptySlot = () => {
                if (isTruckDeparted) {
                    if (!window.confirm(`⚠️ EL MÓVIL ${truckId} ESTÁ EN RUTA.\n\n¿Estás seguro que quieres dejar este lugar VACÍO?`)) {
                        return;
                    }
                }
                onAssign(null);
            };

            const handleAbsentFlow = (reason) => {
                if (isTruckDeparted) {
                    if (!window.confirm(`⚠️ EL MÓVIL ${truckId} ESTÁ EN RUTA.\n\n¿Estás seguro que quieres marcar AUSENTE a un miembro de un equipo que ya salió?`)) {
                        return;
                    }
                }
                onMarkAbsent(reason);
            };

            if (!isOpen) return null;

            if (isMarkingAbsent) {
                return (
                    <div className={`fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm`}>
                        <div className={`${darkMode ? 'bg-slate-900 text-white border border-slate-700' : 'bg-white text-black'} w-full max-w-md rounded-2xl shadow-2xl flex flex-col p-6 animate-in zoom-in duration-200`}>
                            <h3 className="font-bold text-xl mb-4 text-red-600 flex items-center gap-2">
                                <UserX /> Marcar como Ausente
                            </h3>
                            <p className="mb-2 text-sm font-medium opacity-80">Motivo de la ausencia (Requerido):</p>
                            
                            <textarea 
                                placeholder="Ej: Enfermedad, Permiso, Falta sin aviso..." 
                                value={absentReason}
                                onChange={(e) => setAbsentReason(e.target.value)}
                                className="w-full p-4 rounded-xl border-2 border-slate-300 bg-slate-50 dark:bg-slate-800 dark:border-slate-600 mb-6 outline-none focus:border-red-500 text-black dark:text-white font-normal h-32 resize-none"
                                autoFocus
                            />

                            <div className="flex gap-3">
                                <button 
                                    onClick={() => setIsMarkingAbsent(false)}
                                    className="flex-1 py-3 rounded-xl font-bold bg-slate-200 text-slate-800 hover:bg-slate-300 dark:bg-slate-700 dark:text-white"
                                >
                                    Cancelar
                                </button>
                                <button 
                                    onClick={() => handleAbsentFlow(absentReason || "Sin motivo especificado")}
                                    className="flex-1 py-3 rounded-xl font-bold bg-red-600 text-white hover:bg-red-700 shadow-lg shadow-red-500/30"
                                >
                                    Confirmar
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className={`fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm`}>
                    <div className={`${darkMode ? 'bg-slate-900 text-white border border-slate-700' : 'bg-white text-black'} w-full max-w-md rounded-2xl shadow-2xl flex flex-col max-h-[85vh]`}>
                        <div className="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900/50 rounded-t-2xl">
                            <h3 className="font-black text-lg">ASIGNAR PERSONAL</h3>
                            <button onClick={onClose}><X size={28} className="text-slate-500 hover:text-red-500" /></button>
                        </div>
                        
                        <div className="p-3 grid grid-cols-2 gap-3 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900/50">
                            <button 
                                onClick={() => setIsMarkingAbsent(true)}
                                className="flex flex-col items-center justify-center gap-1 p-3 rounded-xl bg-red-100 text-red-700 hover:bg-red-200 dark:bg-red-900/30 dark:text-red-300 dark:hover:bg-red-900/50 transition-colors font-bold text-sm border border-red-200 dark:border-red-800"
                            >
                                <UserX size={20} />
                                <span>MARCAR AUSENTE</span>
                            </button>
                            <button 
                                onClick={handleEmptySlot}
                                className="flex flex-col items-center justify-center gap-1 p-3 rounded-xl bg-slate-200 text-slate-800 hover:bg-slate-300 dark:bg-slate-700 dark:text-white dark:hover:bg-slate-600 transition-colors font-bold text-sm border border-slate-300 dark:border-slate-600"
                            >
                                <UserMinus size={20} />
                                <span>DEJAR VACÍO</span>
                            </button>
                        </div>

                        <div className="p-3 border-b border-slate-200 dark:border-slate-700">
                           <div className="relative">
                             <Search className="absolute left-3 top-3 text-slate-500" size={18} />
                             <input type="text" placeholder="Buscar personal..." className="w-full pl-10 pr-3 py-3 rounded-xl bg-slate-100 dark:bg-slate-800 dark:text-white border-2 border-transparent focus:border-blue-500 dark:border-slate-700 outline-none font-medium" />
                           </div>
                        </div>

                        <div className="overflow-y-auto p-2 flex-1 space-y-2">
                          <h4 className="text-xs font-black text-slate-400 uppercase mb-2 px-2 tracking-wider">Disponibles</h4>
                          {availableStaff.map(person => (
                            <button
                              key={person.id}
                              onClick={() => onAssign(person.id)}
                              className={`w-full text-left p-4 rounded-xl flex items-center justify-between group transition-all border-2
                                ${person.isDriver ? 'bg-blue-50 border-blue-200 dark:bg-blue-900/10 dark:border-blue-800' : 'bg-white border-slate-100 dark:bg-slate-800 dark:border-slate-700'}
                                hover:border-blue-500 dark:hover:border-blue-400
                              `}
                            >
                              <div>
                                <div className="font-normal text-black dark:text-white text-base">{person.name}</div>
                                <div className="text-xs font-normal text-slate-500 dark:text-slate-400 uppercase mt-0.5">{person.role}</div>
                              </div>
                              <div className="flex gap-1">
                                {person.isDriver && (
                                    <span className="text-[10px] font-bold text-white bg-blue-600 px-2 py-1 rounded shadow-sm tracking-wide">CHOFER</span>
                                )}
                                {person.isFletero && (
                                    <span className="text-[10px] font-bold text-white bg-orange-500 px-2 py-1 rounded shadow-sm tracking-wide">FLETERO</span>
                                )}
                              </div>
                            </button>
                          ))}
                          {availableStaff.length === 0 && (
                             <div className="text-center py-8 opacity-50 flex flex-col items-center">
                                <Users size={40} className="mb-2"/>
                                <p className="font-medium">No hay nadie disponible</p>
                             </div>
                          )}
                        </div>
                    </div>
                </div>
            );
        };

        const ManageStaffModal = ({ isOpen, onClose, staff, onAdd, onDelete, onToggleDriver, newStaffData, setNewStaffData, darkMode }) => {
            if (!isOpen) return null;
            return (
                <div className={`fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in`}>
                <div className={`${darkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'} w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh]`}>
                    <div className="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-900/50 rounded-t-2xl">
                    <h3 className="font-black text-xl flex items-center gap-2"><Users/> GESTIÓN DE PERSONAL</h3>
                    <button onClick={onClose}><X size={28}/></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4">
                        <div className={`p-4 rounded-xl mb-6 ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-blue-50 border-blue-100'} border-2`}>
                            <h4 className="font-bold mb-3 flex items-center gap-2 text-blue-600 dark:text-blue-400">Agregar Nuevo</h4>
                            <div className="flex flex-col gap-3">
                                <input type="text" value={newStaffData.name} onChange={e => setNewStaffData({ ...newStaffData, name: e.target.value })}
                                    className="w-full p-3 rounded-lg border-2 border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-black dark:text-white font-medium outline-none focus:border-blue-500" placeholder="Nombre Completo" />
                                <div className="flex gap-2">
                                    <select value={newStaffData.role} onChange={e => setNewStaffData({ ...newStaffData, role: e.target.value })}
                                        className="flex-1 p-3 rounded-lg border-2 border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 text-black dark:text-white font-medium outline-none">
                                        <option value="Entregador">Entregador</option>
                                        <option value="Ayudante">Ayudante</option>
                                        <option value="Volante">Volante</option>
                                    </select>
                                    <label className={`flex items-center px-4 rounded-lg border-2 cursor-pointer ${newStaffData.isDriver ? 'bg-blue-100 border-blue-300 text-blue-800' : 'bg-white border-slate-200 text-slate-500'}`}>
                                        <input type="checkbox" checked={newStaffData.isDriver} onChange={e => setNewStaffData({ ...newStaffData, isDriver: e.target.checked })} className="w-5 h-5 mr-2 accent-blue-600"/>
                                        <span className="font-bold text-sm">Chofer</span>
                                    </label>
                                </div>
                                <button onClick={onAdd} disabled={!newStaffData.name.trim()} className="w-full p-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 disabled:opacity-50">Guardar</button>
                            </div>
                        </div>
                        <div className="space-y-2">
                            {[...staff].sort((a, b) => a.name.localeCompare(b.name)).map(person => (
                                <div key={person.id} className={`flex items-center justify-between p-3 rounded-lg border-2 ${darkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'} shadow-sm`}>
                                    <div>
                                        <div className="font-medium text-lg text-black dark:text-white">{person.name}</div>
                                        <div className="text-sm font-normal text-slate-500 dark:text-slate-400">{person.role}</div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                         <button onClick={() => onToggleDriver(person.id)} className={`px-3 py-1.5 rounded-lg font-bold text-xs border-2 ${person.isDriver ? 'bg-blue-100 text-blue-700 border-blue-200' : 'bg-slate-100 text-slate-500 border-slate-200'}`}>{person.isDriver ? 'ES CHOFER' : 'NO CHOFER'}</button>
                                         <button onClick={() => onDelete(person.id)} className="p-2 text-red-500 bg-red-50 rounded-lg hover:bg-red-100"><Trash2 size={20}/></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div></div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, darkMode, toggleTheme, onOpenManageStaff, onResetDay }) => {
            if (!isOpen) return null;
            
            return (
                <div 
                    className="fixed inset-0 z-50 flex items-start justify-end p-4 bg-black/20 backdrop-blur-[2px]"
                    onClick={onClose}
                >
                    <div 
                        className={`w-64 mt-14 rounded-2xl shadow-2xl border flex flex-col overflow-hidden animate-in slide-in-from-top-5 ${darkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-white border-slate-200 text-slate-900'}`}
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="p-4 border-b border-slate-200 dark:border-slate-700 font-bold bg-slate-50 dark:bg-slate-900/50">
                            Configuración
                        </div>
                        
                        <div className="p-2">
                            <button 
                                onClick={() => { toggleTheme(); }}
                                className="w-full text-left p-3 rounded-lg flex items-center gap-3 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"
                            >
                                {darkMode ? <Sun className="text-orange-400" size={20} /> : <Moon className="text-slate-600" size={20} />}
                                <span className="font-medium">Tema {darkMode ? 'Claro' : 'Oscuro'}</span>
                            </button>

                            <button 
                                onClick={() => { onClose(); onOpenManageStaff(); }}
                                className="w-full text-left p-3 rounded-lg flex items-center gap-3 hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors text-blue-600 dark:text-blue-400"
                            >
                                <Users size={20} />
                                <span className="font-medium">Gestionar Personal</span>
                            </button>

                            <button 
                                onClick={onResetDay}
                                className="w-full text-left p-3 rounded-lg flex items-center gap-3 hover:bg-red-50 text-red-600 dark:hover:bg-red-900/20 transition-colors mt-2 border-t border-slate-100 dark:border-slate-700"
                            >
                                <RotateCcw size={20} />
                                <span className="font-bold">Reiniciar Día (Borrar Todo)</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [showSplash, setShowSplash] = useState(true);
            const [darkMode, setDarkMode] = useState(false);
            const [currentView, setCurrentView] = useState('dashboard');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [saveStatus, setSaveStatus] = useState('saved'); 
            const [searchTerm, setSearchTerm] = useState("");
            
            const [assignments, setAssignments] = useState(INITIAL_ASSIGNMENTS);
            const [truckStatus, setTruckStatus] = useState({}); 
            const [staff, setStaff] = useState(INITIAL_STAFF_DATA);
            const [absentStaffIds, setAbsentStaffIds] = useState(new Set());
            const [absentReasons, setAbsentReasons] = useState({}); 
            const [isDataLoaded, setIsDataLoaded] = useState(false);

            const [selectedSlot, setSelectedSlot] = useState(null); 
            const [showStaffModal, setShowStaffModal] = useState(false);
            const [showManageStaffModal, setShowManageStaffModal] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [newStaffData, setNewStaffData] = useState({ name: '', role: 'Ayudante', isDriver: false });
            const pdfLibraryLoaded = useRef(false);

            useEffect(() => {
                const timer = setTimeout(() => setShowSplash(false), 2500);
                const legacyAssignments = localStorage.getItem('logistica_assignments');
                if (legacyAssignments) {
                    const today = new Date().toISOString().split('T')[0];
                    const legacyKey = `logistica_record_${today}`;
                    if (!localStorage.getItem(legacyKey)) {
                        const legacyData = {
                            assignments: JSON.parse(legacyAssignments),
                            truckStatus: JSON.parse(localStorage.getItem('logistica_status') || '{}'),
                            absentStaffIds: JSON.parse(localStorage.getItem('logistica_absent') || '[]'),
                            absentReasons: {}
                        };
                        localStorage.setItem(legacyKey, JSON.stringify(legacyData));
                    }
                }
                const savedStaff = localStorage.getItem('logistica_staff');
                if (savedStaff) setStaff(JSON.parse(savedStaff));
                if (window.jspdf) pdfLibraryLoaded.current = true;
                const handleBeforeUnload = (e) => { e.preventDefault(); e.returnValue = ''; return ''; };
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => { clearTimeout(timer); window.removeEventListener('beforeunload', handleBeforeUnload); };
            }, []);

            useEffect(() => {
                setIsDataLoaded(false); 
                const recordKey = `logistica_record_${date}`;
                const savedRecord = localStorage.getItem(recordKey);
                if (savedRecord) {
                    const parsed = JSON.parse(savedRecord);
                    setAssignments(parsed.assignments || INITIAL_ASSIGNMENTS);
                    setTruckStatus(parsed.truckStatus || {});
                    setAbsentStaffIds(new Set(parsed.absentStaffIds || []));
                    setAbsentReasons(parsed.absentReasons || {});
                } else {
                    setAssignments(INITIAL_ASSIGNMENTS);
                    setTruckStatus({});
                    setAbsentStaffIds(new Set());
                    setAbsentReasons({});
                }
                setTimeout(() => setIsDataLoaded(true), 50);
            }, [date]);

            useEffect(() => {
                if (!isDataLoaded) return;
                setSaveStatus('saving');
                const recordKey = `logistica_record_${date}`;
                const dataToSave = { assignments, truckStatus, absentStaffIds: Array.from(absentStaffIds), absentReasons };
                try {
                    localStorage.setItem(recordKey, JSON.stringify(dataToSave));
                    localStorage.setItem('logistica_staff', JSON.stringify(staff));
                    setTimeout(() => setSaveStatus('saved'), 600);
                } catch (e) { console.error(e); setSaveStatus('error'); }
            }, [assignments, truckStatus, absentStaffIds, absentReasons, staff, date, isDataLoaded]);

            // --- Lógica del Negocio ---
            const getStaffById = (id) => staff.find(s => s.id === id);
            const getAvailableStaff = () => {
                const assignedIds = new Set();
                Object.values(assignments).forEach(truck => {
                    if (!truck) return; 
                    if (truck.driver) assignedIds.add(truck.driver);
                    if (truck.helper1) assignedIds.add(truck.helper1);
                    if (truck.helper2) assignedIds.add(truck.helper2);
                });
                return staff.filter(s => !assignedIds.has(s.id) && !absentStaffIds.has(s.id));
            };
            const getAbsentStaff = () => staff.filter(s => absentStaffIds.has(s.id));
            
            const findTruckByPersonId = (personId) => {
                for (const truckId of Object.keys(assignments)) {
                    const truck = assignments[truckId];
                    if (truck.driver === personId || truck.helper1 === personId || truck.helper2 === personId) return truckId;
                }
                return null;
            };

            const filteredTrucks = useMemo(() => {
                if (!searchTerm.trim()) return INITIAL_TRUCKS;
                const lowerTerm = searchTerm.toLowerCase();
                return INITIAL_TRUCKS.filter(truckId => {
                    if (truckId.toLowerCase().includes(lowerTerm)) return true;
                    const data = assignments[truckId] || {};
                    const driverName = data.driver ? getStaffById(data.driver)?.name.toLowerCase() : "";
                    const h1Name = data.helper1 ? getStaffById(data.helper1)?.name.toLowerCase() : "";
                    const h2Name = data.helper2 ? getStaffById(data.helper2)?.name.toLowerCase() : "";
                    return driverName?.includes(lowerTerm) || h1Name?.includes(lowerTerm) || h2Name?.includes(lowerTerm);
                });
            }, [searchTerm, assignments, staff]);

            // --- MANEJADORES DE ACCIONES ---

            const handleSlotClick = (truckId, slotType) => {
                if (truckStatus[truckId] === 'departed') {
                    if (!window.confirm(`⚠️ ADVERTENCIA: El móvil ${truckId} ya está EN RUTA.\n\n¿Realmente necesitas modificar su tripulación?`)) {
                        return;
                    }
                }
                setSelectedSlot({ truckId, slotType });
                setShowStaffModal(true);
            };

            const handleAssign = (personId) => {
                if (!selectedSlot) return;
                const { truckId, slotType } = selectedSlot;

                if (truckStatus[truckId] === 'departed') {
                    // Ya se validó al abrir, pero por seguridad doble check
                }

                if (personId) {
                    const currentTruckId = findTruckByPersonId(personId);
                    if (currentTruckId && currentTruckId !== truckId) {
                        if (truckStatus[currentTruckId] === 'departed') {
                            const personName = getStaffById(personId)?.name;
                            alert(`⛔ NO PERMITIDO\n\n${personName} está en el móvil ${currentTruckId} que ya salió EN RUTA.`);
                            return; 
                        }
                    }
                }

                setAssignments(prev => {
                    const newAssignments = { ...prev };
                    if (personId) {
                        Object.keys(newAssignments).forEach(tId => {
                            const truck = { ...newAssignments[tId] };
                            let changed = false;
                            if (truck.driver === personId) { truck.driver = null; changed = true; }
                            if (truck.helper1 === personId) { truck.helper1 = null; changed = true; }
                            if (truck.helper2 === personId) { truck.helper2 = null; changed = true; }
                            if (changed) newAssignments[tId] = truck;
                        });
                    }
                    const targetTruck = { ...(newAssignments[truckId] || { driver: null, helper1: null, helper2: null, observation: "" }) };
                    targetTruck[slotType] = personId;
                    newAssignments[truckId] = targetTruck;
                    return newAssignments;
                });
                
                setShowStaffModal(false);
                setSelectedSlot(null);
            };

            const markAsAbsent = (id, reason) => {
                if (!id) return;
                const currentTruckId = findTruckByPersonId(id);
                if (currentTruckId && truckStatus[currentTruckId] === 'departed') {
                     const personName = getStaffById(id)?.name;
                     alert(`⛔ No puedes marcar ausente a ${personName} porque está en el móvil ${currentTruckId} EN RUTA.`);
                     return;
                }
                if (reason) setAbsentReasons(prev => ({...prev, [id]: reason}));
                setAssignments(prev => {
                    const newAssignments = { ...prev };
                    Object.keys(newAssignments).forEach(tId => {
                        const truck = { ...newAssignments[tId] };
                        if (truck.driver === id) truck.driver = null;
                        if (truck.helper1 === id) truck.helper1 = null;
                        if (truck.helper2 === id) truck.helper2 = null;
                        newAssignments[tId] = truck;
                    });
                    return newAssignments;
                });
                setAbsentStaffIds(prev => new Set(prev).add(id));
                setShowStaffModal(false);
            };

            const handleMarkCurrentSlotAbsent = (reason) => {
                if(!selectedSlot) return;
                const { truckId, slotType } = selectedSlot;
                if (truckStatus[truckId] === 'departed') {
                    if (!window.confirm(`⚠️ El móvil ${truckId} está EN RUTA.\n¿Seguro que deseas marcar AUSENTE a este integrante?`)) {
                        return;
                    }
                }
                const currentPersonId = assignments[truckId]?.[slotType];
                if (currentPersonId) markAsAbsent(currentPersonId, reason);
                setShowStaffModal(false);
            };

            const markAsPresent = (id) => {
                setAbsentStaffIds(prev => {
                    const newSet = new Set(prev);
                    newSet.delete(id);
                    return newSet;
                });
                setAbsentReasons(prev => {
                    const newReasons = {...prev};
                    delete newReasons[id];
                    return newReasons;
                });
            };

            const handleAddStaff = () => {
                if (!newStaffData.name.trim()) return;
                const newId = staff.length > 0 ? Math.max(...staff.map(s => s.id)) + 1 : 1;
                const newPerson = { ...newStaffData, id: newId, isFletero: false };
                setStaff(prev => [...prev, newPerson]);
                setNewStaffData({ name: '', role: 'Ayudante', isDriver: false }); 
            };

            const handleDeleteStaff = (id) => {
                if (window.confirm('¿Seguro que deseas eliminar a esta persona del sistema?')) {
                    setAssignments(prev => {
                        const newAssignments = { ...prev };
                        Object.keys(newAssignments).forEach(tId => {
                            const truck = { ...newAssignments[tId] };
                            if (truck.driver === id) truck.driver = null;
                            if (truck.helper1 === id) truck.helper1 = null;
                            if (truck.helper2 === id) truck.helper2 = null;
                            newAssignments[tId] = truck;
                        });
                        return newAssignments;
                    });
                    setAbsentStaffIds(prev => {
                        const newSet = new Set(prev);
                        newSet.delete(id);
                        return newSet;
                    });
                    setStaff(prev => prev.filter(s => s.id !== id));
                }
            };

            const toggleDriverStatus = (id) => {
                setStaff(prevStaff => prevStaff.map(s => s.id === id ? { ...s, isDriver: !s.isDriver } : s));
            };

            const toggleTruckStatus = (truckId) => {
                setTruckStatus(prev => ({...prev, [truckId]: prev[truckId] === 'departed' ? 'pending' : 'departed'}));
            };
            const updateObservation = (truckId, text) => {
                setAssignments(prev => {
                    const newAssignments = { ...prev };
                    newAssignments[truckId] = { ...newAssignments[truckId], observation: text };
                    return newAssignments;
                });
            };
            const handleResetDay = () => {
                if (window.confirm("¿REINICIAR TODO EL DÍA?\nSe borrarán todas las asignaciones.")) {
                    setAssignments(createEmptyAssignments()); setTruckStatus({}); setAbsentStaffIds(new Set()); setAbsentReasons({}); setShowSettingsModal(false);
                }
            };

            // PDF Export
            const exportPDF = () => {
                if (!window.jspdf) return alert("Cargando librerías...");
                const doc = new window.jspdf.jsPDF();
                
                doc.setFontSize(18); doc.text("Reporte Diario de Logística", 14, 14);
                doc.setFontSize(12); doc.text(`Fecha: ${date}`, 14, 22);

                const tableConfig = { 
                    theme: 'grid', 
                    headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
                    styles: { fontSize: 9, cellPadding: 2, valign: 'middle' }
                };
                
                const getTableData = (ids) => ids.map(id => {
                    const d = assignments[id] || {};
                    return [
                        id, 
                        d.driver ? getStaffById(d.driver).name : "-", 
                        d.helper1 ? getStaffById(d.helper1).name : "-", 
                        d.helper2 ? getStaffById(d.helper2).name : "-", 
                        d.observation || ""
                    ];
                });

                let y = 30;
                const departed = INITIAL_TRUCKS.filter(id => truckStatus[id] === 'departed');
                doc.setFontSize(14); doc.setTextColor(0, 128, 0); doc.text(`EN RUTA (${departed.length})`, 14, y);
                y += 6;
                if (departed.length) {
                    doc.autoTable({ startY: y, head: [["Móvil", "Chofer", "Ayudante 1", "Ayudante 2", "Obs"]], body: getTableData(departed), ...tableConfig, headStyles: { fillColor: [46, 125, 50] } });
                    y = doc.lastAutoTable.finalY + 10;
                }

                const pending = INITIAL_TRUCKS.filter(id => truckStatus[id] !== 'departed');
                if (y > 250) { doc.addPage(); y = 20; }
                doc.setFontSize(14); doc.setTextColor(180, 0, 0); doc.text(`PENDIENTES (${pending.length})`, 14, y);
                y += 6;
                if (pending.length) {
                    doc.autoTable({ startY: y, head: [["Móvil", "Chofer", "Ayudante 1", "Ayudante 2", "Obs"]], body: getTableData(pending), ...tableConfig, headStyles: { fillColor: [183, 28, 28] } });
                    y = doc.lastAutoTable.finalY + 10;
                }

                if (y > 250) { doc.addPage(); y = 20; }
                const available = getAvailableStaff();
                doc.setFontSize(14); doc.setTextColor(0,0,0); doc.text(`DISPONIBLES (${available.length})`, 14, y);
                y += 6;
                if(available.length) {
                    doc.autoTable({ startY: y, head: [["Nombre", "Rol", "Detalle"]], body: available.map(p => [p.name, p.role, (p.isDriver ? 'CHOFER' : '') + (p.isFletero ? ' FLETERO' : '')]), ...tableConfig, headStyles: { fillColor: [100, 116, 139] } });
                    y = doc.lastAutoTable.finalY + 10;
                }

                if (y > 250) { doc.addPage(); y = 20; }
                const absents = getAbsentStaff();
                doc.setFontSize(14); doc.setTextColor(0,0,0); doc.text(`AUSENTES (${absents.length})`, 14, y);
                y += 6;
                if (absents.length) {
                    doc.autoTable({ startY: y, head: [["Nombre", "Rol", "Motivo"]], body: absents.map(p => [p.name, p.role, absentReasons[p.id] || "-"]), ...tableConfig, headStyles: { fillColor: [50, 50, 50] } });
                }
                
                doc.save(`logistica_${date}.pdf`);
            };

            if (showSplash) return (
              <div className="flex flex-col items-center justify-center h-screen bg-slate-900 text-white animate-fade-in">
                <div className="relative mb-6">
                  <div className="absolute inset-0 bg-blue-500 blur-xl opacity-50 rounded-full"></div>
                  <Truck size={80} className="relative z-10 text-blue-400" />
                </div>
                <h1 className="text-4xl font-bold tracking-widest mb-2">LOGÍSTICA</h1>
                <p className="text-slate-400 text-sm">Sistema de Control de Personal</p>
                <p className="absolute bottom-10 text-xs text-slate-600">Versión 5.0.0</p>
              </div>
            );

            return (
                <div className={`min-h-screen ${darkMode ? 'bg-slate-950 text-white' : 'bg-gray-100 text-slate-900'} pb-20`}>
                    {/* Header Simplificado */}
                    <header className={`sticky top-0 z-40 p-4 shadow-md ${darkMode ? 'bg-slate-900' : 'bg-white'}`}>
                        <div className="flex justify-between items-center mb-3">
                            <h1 className="text-2xl font-black tracking-tight flex items-center gap-2 text-slate-900 dark:text-white">
                                LOGÍSTICA
                                {saveStatus === 'saving' && <Loader2 size={16} className="text-slate-400 animate-spin" />}
                                {saveStatus === 'saved' && <Check size={16} className="text-green-500 animate-in fade-in" />}
                            </h1>
                            <div className="flex gap-2">
                                <input type="date" value={date} onChange={e => setDate(e.target.value)} className="bg-transparent font-bold outline-none text-slate-900 dark:text-white" />
                                <button onClick={() => setShowSettingsModal(true)}><Settings className="text-slate-900 dark:text-white" /></button>
                            </div>
                        </div>
                        <div className="relative">
                            <Search className="absolute left-3 top-3 text-gray-400" size={18}/>
                            <input type="text" placeholder="Buscar..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} 
                                className={`w-full pl-10 p-2.5 rounded-xl outline-none border-2 font-medium ${darkMode ? 'bg-slate-800 border-slate-700 text-white' : 'bg-slate-100 border-slate-200 text-slate-900 focus:border-blue-500'}`} />
                        </div>
                    </header>

                    <main className="p-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        {INITIAL_TRUCKS.filter(t => t.includes(searchTerm.toUpperCase())).map(truckId => {
                            const data = assignments[truckId] || {};
                            const isDeparted = truckStatus[truckId] === 'departed';
                            const isBorneo = BORNEO_TRUCKS.has(truckId);
                            const isFletero = FLETERO_TRUCKS.has(truckId);
                            
                            // Estilo condicional para el header del camión
                            let headerStyle = 'bg-blue-600 text-white';
                            if (isDeparted) {
                                headerStyle = 'bg-green-600 text-white'; // Verde siempre domina si salió
                            } else if (isBorneo) {
                                headerStyle = 'bg-orange-500 text-black';
                            } else if (isFletero) {
                                headerStyle = 'bg-purple-600 text-white';
                            }

                            return (
                                <div key={truckId} className={`rounded-xl border-2 p-1 ${isDeparted ? (darkMode ? 'bg-green-900/20 border-green-700' : 'bg-green-50 border-green-500') : (darkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-white shadow-sm')}`}>
                                    <div className={`flex justify-between items-center p-2 mb-1 rounded-lg ${headerStyle}`}>
                                        <span className="text-xl font-black px-2">{truckId}</span>
                                        <button onClick={() => toggleTruckStatus(truckId)} className={`p-2 rounded-full ${isDeparted ? 'bg-white/20 text-white' : 'bg-white/20 text-white hover:bg-white/30'}`}><Truck size={20}/></button>
                                    </div>
                                    
                                    {['driver', 'helper1', 'helper2'].map(slot => (
                                        <div key={slot} onClick={() => handleSlotClick(truckId, slot)} 
                                            className={`mx-2 mb-2 p-2 rounded-lg border-2 border-dashed cursor-pointer ${data[slot] ? (darkMode ? 'bg-slate-800 border-slate-600' : 'bg-slate-50 border-slate-300') : 'border-slate-200 opacity-60'}`}>
                                            <div className="text-[10px] font-medium text-gray-400 uppercase mb-1">{slot === 'driver' ? 'CHOFER' : 'AYUDANTE'}</div>
                                            {data[slot] ? (
                                                <div className="font-normal text-sm truncate text-black dark:text-white flex justify-between items-center">
                                                    {getStaffById(data[slot])?.name}
                                                    {getStaffById(data[slot])?.isDriver && <span className="text-[9px] bg-red-600 text-white px-1 rounded ml-1">CHOFER</span>}
                                                </div>
                                            ) : <span className="text-red-400 font-bold text-sm italic">Vacío</span>}
                                        </div>
                                    ))}
                                    <input type="text" placeholder="Observación..." value={data.observation || ""} onChange={e => updateObservation(truckId, e.target.value)} 
                                        className="w-full bg-transparent p-2 text-sm font-medium text-gray-900 dark:text-white outline-none border-t border-slate-100 dark:border-slate-800" />
                                </div>
                            );
                        })}
                    </main>

                    {/* Botones Flotantes */}
                    <div className="fixed bottom-6 right-6 flex flex-col gap-3 z-[9999]">
                        <button type="button" onClick={() => setCurrentView(currentView === 'dashboard' ? 'report' : 'dashboard')} 
                            className={`w-14 h-14 rounded-full text-white shadow-xl flex items-center justify-center transition-colors pointer-events-auto cursor-pointer ${currentView === 'dashboard' ? 'bg-green-600' : 'bg-blue-600'}`}>
                            {currentView === 'dashboard' ? <FileText size={24}/> : <Truck size={24}/>}
                        </button>
                    </div>

                    {/* Modales */}
                    <StaffSelectorModal isOpen={showStaffModal} onClose={() => setShowStaffModal(false)} availableStaff={getAvailableStaff()} onAssign={handleAssign} onMarkAbsent={handleMarkCurrentSlotAbsent} darkMode={darkMode} truckId={selectedSlot?.truckId} isTruckDeparted={selectedSlot && truckStatus[selectedSlot.truckId] === 'departed'} />
                    <ManageStaffModal isOpen={showManageStaffModal} onClose={() => setShowManageStaffModal(false)} staff={staff} onAdd={handleAddStaff} onDelete={handleDeleteStaff} onToggleDriver={toggleDriverStatus} newStaffData={newStaffData} setNewStaffData={setNewStaffData} darkMode={darkMode} />
                    <SettingsModal isOpen={showSettingsModal} onClose={() => setShowSettingsModal(false)} darkMode={darkMode} toggleTheme={() => setDarkMode(!darkMode)} onOpenManageStaff={() => setShowManageStaffModal(true)} onResetDay={handleResetDay} />
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
